{% extends "layout.html" %}
{% block title %}Lotofácil - Predição{% endblock %}
{% block content %}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h1 class="mb-3"><i class="fa fa-magic"></i> Lotofácil - Predição e Treinamento</h1>
                    <p>Este sistema utiliza inteligência artificial para analisar resultados anteriores da Lotofácil e sugerir jogos com maior potencial. Você pode inserir seus números, pedir sugestões automáticas, salvar ou descartar predições, exportar seu histórico e acompanhar o status do treinamento do modelo.</p>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6 mb-2">
                    <div class="card text-bg-info">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fa fa-cog"></i> Status do Sistema</h5>
                            <p class="card-text">Treinado até o concurso <strong>{{ ultimo_concurso }}</strong></p>
                            {% if em_treinamento %}
                                <span class="badge bg-warning text-dark"><i class="fa fa-cog fa-spin"></i> Em treinamento</span>
                            {% else %}
                                <span class="badge bg-success"><i class="fa fa-check"></i> Pronto para predição</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-2">
                    <div class="card text-bg-primary">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fa fa-chart-bar"></i> Estatísticas</h5>
                            <p class="card-text">Total de predições: <strong>{{ total_predicoes }}</strong><br>Seus jogos salvos: <strong>{{ total_jogos_usuario }}</strong></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fa fa-lightbulb"></i> Dica</h5>
                    <p class="card-text">Utilize o botão de sugestão automática para receber palpites baseados no aprendizado do sistema.</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fa fa-history"></i> Últimas Predições</h5>
                    <ul class="list-group">
                        {% for p in ultimas_predicoes %}
                            <li class="list-group-item">
                                <div class="d-none d-md-block">
                                    <span class="numbers-copy" data-copy="{{ p.numeros|numeros_fmt }}" title="Clique para copiar">{{ p.numeros|numeros_fmt }}</span>
                                    <span class="ms-1">- Pontuação: {{ p.pontuacao }}</span>
                                </div>
                                <div class="d-block d-md-none">
                                    <div class="chips numbers-copy" data-copy="{{ p.numeros|numeros_fmt }}" title="Toque para copiar">
                                        {% for n in p.numeros|numeros_list %}
                                        <span class="chip">{{ n }}</span>
                                        {% endfor %}
                                    </div>
                                    <div class="small text-muted mt-1">Pontuação: {{ p.pontuacao }}</div>
                                </div>
                            </li>
                        {% else %}
                            <li class="list-group-item">Nenhuma predição recente.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mx-auto">
                                                        <form id="predicaoForm" action="/predicao" method="post" onsubmit="return validarNumeros(event)" data-loading data-loading-text="Fazendo predição...">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="d-flex flex-wrap justify-content-center" id="numero-inputs-container">
                    {% for i in range(1, 16) %}
                        <input type="number" name="numero{{ i }}" class="numero-input" min="1" max="25" required style="appearance: none;">
                    {% endfor %}
                </div>
                <div id="validation-feedback" class="alert alert-danger mt-2" style="display: none;"></div>
                <div class="text-center mt-2">
                    {% if predicao_chance_label is defined and predicao_chance_score is not none %}
                        <span id="soma-display" class="badge bg-secondary">Soma: {{ predicao_soma }}</span>
                        <span id="heatmap-badge" class="badge ms-2" style="background: {{ predicao_chance_color }}; color: #fff">Chance: {{ predicao_chance_label }} ({{ predicao_chance_score }}%)</span>
                    {% else %}
                        <span id="soma-display" class="badge bg-secondary">Soma: 0</span>
                        <span id="heatmap-badge" class="badge ms-2" style="background:#e0e0e0;color:#000">Chance: -</span>
                    {% endif %}
                </div>
                <div class="legend">
                    <div class="item"><span class="swatch swatch-prime"></span><small>Primo</small></div>
                    <div class="item"><span class="swatch swatch-par"></span><small>Par</small></div>
                    <div class="item"><span class="swatch swatch-impar"></span><small>Ímpar</small></div>
                </div>
                </form>
            <div class="d-flex justify-content-center flex-wrap gap-2 mt-3">
                <button type="button" class="btn btn-success" onclick="gerarSugestao()" id="btn-sugestao"><i class="fa fa-bolt"></i> Sugestão Automática</button>
                <button type="submit" class="btn btn-primary" form="predicaoForm" id="btn-predicao"><i class="fa fa-search"></i> Fazer Predição</button>
                {% if user_type == 'admin' %}
                <form action="/treinar" method="post" class="m-0" data-loading data-loading-text="Executando treinamento do modelo...">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-outline-danger"><i class="fa fa-robot"></i> Executar Treinamento</button>
                </form>
                {% endif %}
            </div>
            <div id="loading" class="loading alert alert-info" style="display: none;">
                <i class="fa fa-spinner fa-spin"></i> Processando... Por favor, aguarde.
            </div>
            {% if mensagem %}
                <div class="alert alert-success mt-3">{{ mensagem }}</div>
            {% endif %}
            {% if erro %}
                <div class="alert alert-danger mt-3">{{ erro }}</div>
            {% endif %}
            {% if predicao %}
                <div id="predicao-block" class="alert alert-secondary mt-3">
                    <strong>Números previstos:</strong>
                    <div class="chips numbers-copy mt-1" data-copy="{{ predicao.numeros|numeros_fmt }}" title="Toque para copiar">
                        {% for n in predicao.numeros|numeros_list %}
                        <span class="chip">{{ n }}</span>
                        {% endfor %}
                    </div>
                    <br>
                    <strong>Pontuação estimada:</strong> {{ predicao.pontuacao }}<br>
                    {% if predicao_chance_label is defined and predicao_chance_score is not none %}
                        <div class="mt-2">
                            <span id="soma-display" class="badge bg-secondary">Soma: {{ predicao_soma }}</span>
                            <span id="heatmap-badge" class="badge ms-2" style="background: {{ predicao_chance_color }}; color: #fff">Chance: {{ predicao_chance_label }} ({{ predicao_chance_score }}%)</span>
                        </div>
                    {% endif %}
                    <form action="/salvar_predicao" method="post" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="numeros" value="{{ predicao.numeros }}">
                        <input type="hidden" name="pontuacao" value="{{ predicao.pontuacao }}">
                        <button type="submit" class="btn btn-outline-success btn-sm"><i class="fa fa-save"></i> Salvar</button>
                    </form>
                    <form action="/descartar_predicao" method="post" class="d-inline ms-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-outline-danger btn-sm"><i class="fa fa-times"></i> Descartar</button>
                    </form>
                </div>
                <script>
                    // populate soma and badge from server-side precomputed values (if available)
                    (function(){
                        try{
                            const somaEl = document.getElementById('soma-display');
                            const badge = document.getElementById('heatmap-badge');
                            const soma = {{ predicao_soma|default(None)|tojson }};
                            const label = {{ predicao_chance_label|default(None)|tojson }};
                            const score = {{ predicao_chance_score|default(None)|tojson }};
                            if(soma !== null && somaEl) somaEl.textContent = 'Soma: ' + soma;
                            if(label !== null && score !== null && badge){
                                let color = '#d9534f';
                                if(score >= 70) color = '#5cb85c';
                                else if(score >= 40) color = '#f0ad4e';
                                badge.style.background = color; badge.style.color = '#fff';
                                badge.textContent = `Chance: ${label} (${score}%)`;
                            }
                        }catch(e){ console.log('populate badge failed', e); }
                    })();
                </script>
            {% endif %}
        </div>
    </div>
</div>

{% if predicao %}
<script>
    // Quando houver uma predição no servidor, rola suavemente até o bloco de resultado
    document.addEventListener('DOMContentLoaded', function() {
        const el = document.getElementById('predicao-block');
        // if server sent a prediction, try to prefill input fields so heatmap and UI can evaluate it
        try {
            const cells = document.querySelectorAll('.numero-input');
            // predicao.numeros is expected to be a list; render as JSON on server side
            const predNums = {{ predicao.numeros|tojson }};
            if (predNums && cells && predNums.length === cells.length) {
                predNums.forEach((num, idx) => { cells[idx].value = num; });
                // small delay to allow layout then update UI
                setTimeout(() => { updateUI(); }, 120);
            }
        } catch (e) {
            // ignore if parsing fails
            console.log('prefill predicao failed', e);
        }
        if (el) {
            // aguarda um pouco para garantir que o layout esteja pronto
            setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 150);
        }
    });
</script>
{% endif %}

<script>
    // server-provided stats for heatmap (injected as JSON)
    const SERVER_STATS = {{ stats|tojson|safe }};
    const loadingEl = document.getElementById("loading");
    const validationFeedbackEl = document.getElementById("validation-feedback");

    function showLoading(text = 'Processando...') {
        if (window.UXUtils) {
            UXUtils.showLoading(text);
        } else {
            loadingEl.style.display = "block";
        }
    }

    function hideLoading() {
        if (window.UXUtils) {
            UXUtils.hideLoading();
        } else {
            loadingEl.style.display = "none";
        }
    }

    function showValidationFeedback(message) {
        if (window.UXUtils) {
            UXUtils.showToast(message, 'error');
        } else {
            validationFeedbackEl.textContent = message;
            validationFeedbackEl.style.display = "block";
        }
    }

    function hideValidationFeedback() {
        validationFeedbackEl.style.display = "none";
    }

    function validarNumeros(event) {
        const inputs = document.querySelectorAll(".numero-input");
        const valores = Array.from(inputs).map(input => parseInt(input.value));
        const unicos = new Set(valores);
        let isValid = true;
        let errorMessage = "";

        // Clear previous feedback
        hideValidationFeedback();
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'field-error');
            // Remove existing feedback messages
            const feedback = input.parentNode.querySelector('.invalid-feedback, .error-message');
            if (feedback) feedback.remove();
        });

        if (valores.length !== 15) {
            errorMessage = "Por favor, preencha todos os 15 números.";
            isValid = false;
        } else if (unicos.size !== 15) {
            errorMessage = "Os números devem ser únicos.";
            isValid = false;
            // Highlight duplicate numbers
            const counts = {};
            valores.forEach(v => { counts[v] = (counts[v] || 0) + 1; });
            inputs.forEach(input => {
                if (counts[parseInt(input.value)] > 1) {
                    if (window.UXUtils) {
                        UXUtils.validateField(input, false, 'Número duplicado');
                    } else {
                        input.classList.add('is-invalid');
                    }
                }
            });
        } else if (valores.some(v => v < 1 || v > 25 || isNaN(v))) {
            errorMessage = "Todos os números devem estar entre 1 e 25.";
            isValid = false;
            inputs.forEach(input => {
                const v = parseInt(input.value);
                if (v < 1 || v > 25 || isNaN(v)) {
                    if (window.UXUtils) {
                        UXUtils.validateField(input, false, 'Número deve estar entre 1 e 25');
                    } else {
                        input.classList.add('is-invalid');
                    }
                }
            });
        }

        if (!isValid) {
            showValidationFeedback(errorMessage);
            event.preventDefault(); // Prevent form submission
            return false;
        }

        showLoading();
        return true;
    }

    function gerarSugestao() {
        const btnSugestao = document.getElementById('btn-sugestao');
        
        hideValidationFeedback(); // Clear validation feedback when generating suggestion
        
        // Set button loading state
        if (window.UXUtils && btnSugestao) {
            UXUtils.setButtonLoading(btnSugestao, true);
        }
        
        showLoading('Gerando sugestão automática...'); // Show loading indicator for suggestion generation
        
        fetch('/sugestao_automatica')
            .then(response => response.json())
            .then(data => {
                const inputs = document.querySelectorAll('.numero-input');
                inputs.forEach((numInput, idx) => {
                    numInput.value = data.numeros[idx];
                    numInput.classList.remove('is-invalid', 'field-error'); // Clear invalid state
                    // Clear any validation feedback
                    const feedback = numInput.parentNode.querySelector('.invalid-feedback, .error-message');
                    if (feedback) feedback.remove();
                });
                updateUI();
                
                // Show success message
                if (window.UXUtils) {
                    UXUtils.showToast('Sugestão gerada com sucesso!', 'success');
                }
                
                hideLoading(); // Hide loading after suggestion is applied
                
                // Reset button state
                if (window.UXUtils && btnSugestao) {
                    UXUtils.setButtonLoading(btnSugestao, false);
                }
            })
            .catch(error => {
                console.error('Erro ao gerar sugestão:', error);
                hideLoading(); // Hide loading on error
                
                // Reset button state
                if (window.UXUtils && btnSugestao) {
                    UXUtils.setButtonLoading(btnSugestao, false);
                }
                
                showValidationFeedback("Erro ao gerar sugestão automática. Tente novamente.");
            });
    }

    // UTIL: verifica primo
    function isPrime(n) {
        if (!n || n < 2) return false;
        if (n === 2) return true;
        if (n % 2 === 0) return false;
        for (let i = 3; i * i <= n; i += 2) if (n % i === 0) return false;
        return true;
    }

    function updateNumberStyles() {
        const inputs = document.querySelectorAll('.numero-input');
        inputs.forEach(inp => {
            inp.classList.remove('numero-primo','numero-par','numero-impar');
            const v = parseInt(inp.value);
            if (!v) return;
            if (isPrime(v)) inp.classList.add('numero-primo');
            else if (v % 2 === 0) inp.classList.add('numero-par');
            else inp.classList.add('numero-impar');
        });
    }

    function updateSum() {
        const inputs = document.querySelectorAll('.numero-input');
        const valores = Array.from(inputs).map(i => parseInt(i.value) || 0);
        const soma = valores.reduce((a,b) => a + b, 0);
        const el = document.getElementById('soma-display');
        if (el) el.textContent = 'Soma: ' + soma;
        // update heatmap after sum changes
        updateHeatmap(valores, soma);
    }

    // compute a simple "chance score" [0..100] based on stats provided by server
    function updateHeatmap(valores, soma) {
        const badge = document.getElementById('heatmap-badge');
        if (!badge) return;
        // require 15 valid numbers
        if (!valores || valores.length !== 15 || valores.some(v => v <= 0)) {
            badge.style.background = '#e0e0e0'; badge.textContent = 'Chance: -'; return;
        }
        // server stats (injected)
        const stats = SERVER_STATS || {sum_range_counts:[], most_common_primes:[], most_common_evens:[], prime_number_list:[]};
        // score components:
        // 1) sum range alignment: if soma falls in one of the top ranges -> +40
        let sum_score = 0;
        if (stats.sum_range_counts && stats.sum_range_counts.length) {
            const topRanges = stats.sum_range_counts.map(it => it.range);
            // find whether soma fits in top ranges (ranges like '120-140')
            for (let i = 0; i < Math.min(3, topRanges.length); i++) {
                const parts = topRanges[i].split('-').map(x => parseInt(x));
                if (soma >= parts[0] && soma <= parts[1]) {
                    // higher bonus for top-1, then smaller
                    sum_score = 40 - (i * 10);
                    break;
                }
            }
        }
        // 2) prime count closeness: compare count of primes in selection to most_common_primes
        const primesSet = new Set([2,3,5,7,11,13,17,19,23]);
        const primeCount = valores.reduce((acc, v) => acc + (primesSet.has(v) ? 1 : 0), 0);
        let prime_score = 0;
        if (stats.most_common_primes && stats.most_common_primes.length) {
            const common = stats.most_common_primes[0];
            const diff = Math.abs(primeCount - common);
            prime_score = Math.max(0, 30 - diff * 7); // penalize difference
        }
        // 3) parity balance: if even count matches most_common_evens -> +30 scaled
        const evenCount = valores.reduce((acc, v) => acc + (v % 2 === 0 ? 1 : 0), 0);
        let parity_score = 0;
        if (stats.most_common_evens && stats.most_common_evens.length) {
            const commonEven = stats.most_common_evens[0];
            const diffE = Math.abs(evenCount - commonEven);
            parity_score = Math.max(0, 30 - diffE * 6);
        }

        // combine scores into 0..100
        let score = Math.round(Math.min(100, sum_score + prime_score + parity_score));

        // pick color bands
        let color = '#d9534f'; // red
        let label = 'Baixa';
        if (score >= 70) { color = '#5cb85c'; label = 'Alta'; }
        else if (score >= 40) { color = '#f0ad4e'; label = 'Média'; }

        badge.style.background = color;
        badge.style.color = '#fff';
        badge.textContent = `Chance: ${label} (${score}%)`;
    }

    function updateUI() {
        updateNumberStyles();
        updateSum();
    }

    // adicionar listeners para atualizar enquanto o usuário digita
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.numero-input');
        inputs.forEach(inp => inp.addEventListener('input', updateUI));
        // update once on load (covers when predicao or sugestao já preenchidos)
        updateUI();
    });
</script>

<script>
// Copiar números ao tocar/clicar em um bloco com class "numbers-copy"
(function(){
  function copyText(txt){
    try { if (navigator.clipboard && navigator.clipboard.writeText) { return navigator.clipboard.writeText(txt); } } catch(e) {}
    return new Promise(function(resolve,reject){
      try {
        var ta = document.createElement('textarea');
        ta.value = txt; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.focus(); ta.select();
        var ok = document.execCommand('copy');
        document.body.removeChild(ta);
        ok ? resolve() : reject();
      } catch(e){ reject(e); }
    });
  }
  document.addEventListener('click', function(ev){
    var el = ev.target.closest('.numbers-copy');
    if(!el) return;
    var txt = el.getAttribute('data-copy') || el.innerText || '';
    copyText(txt).then(function(){ alert('Números copiados'); }).catch(function(){ alert('Não foi possível copiar'); });
  });
})();
</script>
{% endblock %}
